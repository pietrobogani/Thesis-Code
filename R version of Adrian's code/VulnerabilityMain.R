                                              #%% Quantile regressions and density matching

# % This script estimates quantile regressions of future GDP on current
# % values of GDP and the NFCI, and matches skewed t-distributions to the 
# % estimated quantiles. It produces the charts presented in the following
# % figures:
#   % - Figure 1. Distribution of GDP growth over time.
# % - Figure 5. Predicted Distributions.
# % - Figure 6. Median, Interquartile Range, and 5 Percent Quantile of the
# %             Predicted Distribution.
# % - Figure 7. The Conditional Quantiles and the Skewed t-Distribution.
# % - Figure 8. Probability Densities.
# % - Figure 9. Growth Entropy and Expected Shortfall over Time.
# % - Figure 13. Mean, Volatility, and Entropy.
# % - Figure 14. Median, Interquartile Range, and 5 Percent Quantile.
# % - Figure A.1. Predictive Distribution of GDP Growth: Location and Scale
# %               Parameters over Time.
# % - Figure A.2. Predictive Distribution of GDP Growth: Shape and Degrees of
# %               Freedom over Time.
# % - Figures A.3 and A.4. Predictive Distribution of GDP Growth: Moments
# %                        over Time.
# % 
# % This script requires MATLAB's Optimization Toolbox.
# % 
# % From the replication files for:
# % Tobias Adrian, Nina Boyarchenko, and Domenico Giannone (2018):
# % "Vulnerable Growth," American Economic Review.






# Required libraries
library(quantreg)  # for quantile regression
library(ggplot2)   # for plotting
library(readxl)


# Clear the workspace
rm(list=ls())

# Set graphics settings
theme_set(theme_bw(base_size = 15))



# Should saved density matching results be loaded?
load_saved_results <- TRUE

# Load data
# Specify the path to your .xls file
file_path <- "DataVulnerabilityAppendix.xls"

# Read the file
data <- read_excel(file_path)
data<-data[,1:3]
colnames(data)[1] <- "Time"
data$Time <- as.Date(data$Time)


# Subset the data
#time <- time[time >= as.Date("1973-01-01") & time <= as.Date("2015-10-01")]
data <- data[data$Time >= as.Date("1973-01-01") & data$Time <= as.Date("2015-10-01"), ]
Time <- data$Time
X <- data[,2:3]

# Forecast settings
H <- c(1, 4)
QQ <- seq(0.05, 0.95, by = 0.05)
jq05 <- which.min(abs(QQ - 0.05))
jq25 <- which.min(abs(QQ - 0.25))
jq50 <- which.min(abs(QQ - 0.50))
jq75 <- which.min(abs(QQ - 0.75))
jq95 <- which.min(abs(QQ - 0.95))


# Construct average growth rates
y <- X$A191RL1Q225SBEA
Yh <- matrix(0, nrow=length(y), ncol=4)


for(h in 1:4){
  filtered <- filter(y, rep(1/h, h), sides=1)
  Yh[1:length(filtered), h] <- filtered
  if (h>1){
     Yh[1:(h-1), h] <- NA
  }
}              # Yh corretto

# Dates for plotting density
JT <- c(134,144,168)

# axis limits for various plots (to be adapted in ggplot)
ylims_pred_dist <- matrix(c(-15, 20, NA, NA, NA, NA, -15, 10), ncol=2, byrow=TRUE)



QRboot_env <- new.env()

source("QRboot.R",local = QRboot_env)


# Main results
ResMain <- QRboot_env$QRboot(X$NFCI,y,H,1, QQ)  #CORRETTO!!!!
ResGDPonly <- QRboot_env$QRboot(matrix(nrow = 0, ncol = 0),y,H,1, QQ) #CORRETTO!!!!
ResUnc <- QRboot_env$QRboot(matrix(nrow = 0, ncol = 0),y,H,0, QQ) #CORRETTO!!!!


PlotPredictiveTS_env <- new.env()
source("PlotPredictiveTS.r",local = PlotPredictiveTS_env)

#----------------- fin qui giusto

# Loop over forecast horizons
for (h in H) {
  
  # Get quantiles of predictive distribution
  YQunc <- ResUnc$YQ[nrow(ResUnc$YQ), , h]
  YQ <- ResMain$YQ[, , h]
  Y2 <- ResMain$Y2[, h]
  YQGDPonly <- ResGDPonly$YQ[, , h]
  QQ <- ResMain$QQ
  
#####---------------------- Figure 5: Predicted Distributions. Il plot non è perfetto, ma comunque sufficientemente simile all'originale
 PlotPredictiveTS_env$PlotPredictiveTS(YQ, QQ, Time, Yh[, h]) 
 
 
 
 #####--------------------- Figure 6: Median, Interquartile Range, and 5 Percent Quantile
 #ci sono errori, YQ è lo stesso che in Matlab, ma qui meno punti vengono plottati....
 
 valid_rows <- complete.cases(YQ[, c(jq75, jq25, jq50)])
 
 
 # (a)/(b) Median and Interquartile Range
 plot(YQ[valid_rows, jq75] - YQ[valid_rows, jq25], YQ[valid_rows, jq50], 
            col = rgb(20/255, 91/255, 142/255), 
            xlim = c(1, 8), ylim = c(-3, 5), 
            pch = 19, cex = 2.5, xlab = "Interquartile range", 
            ylab = "Median", frame = FALSE)
 box()

 # (c)/(d) Q5 and Interquartile Range
 plot(YQ[valid_rows, jq75] - YQ[valid_rows, jq25], YQ[valid_rows, jq05], 
            col = rgb(20/255, 91/255, 142/255), 
            xlim = c(1, 8), ylim = c(-15, 5), 
            pch = 19, cex = 2.5, xlab = "Interquartile range", 
            ylab = "5th quantile", frame = FALSE)
 box()
 

 
}


