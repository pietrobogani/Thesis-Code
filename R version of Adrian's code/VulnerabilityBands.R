# Graphics settings (place equivalent R settings here if needed)

# Load data
library(readxl)
library(quantreg)


file_path <- "DataVulnerabilityAppendix.xls"

# Read the file
data <- read_excel(file_path)
colnames(data)[1] <- "Time"
data$Time <- as.Date(data$Time)

# Use 1973Q1-2015Q4 subsample
data <- data[data$Time >= as.Date("1973-01-01") & data$Time <= as.Date("2015-10-01"), ]

Time <- data$Time
X <- data[,2:3]
Mnem <- colnames(data)[2:3]


# Forecast settings
H <- c(1, 4)
QQ <- seq(0.05, 0.95, by = 0.05)

# Construct average growth rates
y <- X$A191RL1Q225SBEA
Yh <- matrix(0, nrow=length(y), ncol=length(H))


for(idx in 1:length(H)){
  h <- H[idx]
  filtered <- filter(y, rep(1/h, h), sides=1)
  Yh[1:length(filtered), idx] <- filtered
  Yh[1:(h-1), idx] <- NA
}




# Bootstrap settings
nDrawsBoot <- 1000
nLagsBootVAR <- 4
#-------------------- controllare da qua in giù
QRboot_env <- new.env()

source("QRboot.R",local = QRboot_env)

Res <- QRboot_env$QRboot(X[, 2], y, H, 1, QQ, nDrawsBoot, nLagsBootVAR)

#TUTTO DOVREBBE ESSERE OKAY, MA bB2 AND bBQ HANNO VALORI COSTANTI PER I 1000 VALORI DI BOOTSTRAP....
#Da altro codice, si evince che quando uso QRboot senza bootstrap, è corretta





PlotQRBands_env <- new.env()

source("PlotQRBands.R",local = PlotQRBands_env)

# Plot results
for(j in 2:3){
  if(j == 2){
    regressorName <- 'NFCI'
    ylims <- c(-3.0, 1.5)
  } else if(j == 3){
    regressorName <- 'GDP'
    ylims <- c(-0.2, 0.5)
  }
  
  for(h in H){
    BQ <- Res$BQ[j,,h]
    B2 <- Res$B2[j,h]
    bBQ <- Res$bBQ[j,,h,]
    bB2 <- Res$bB2[j,h,]
    cat("Dimensions of bBQ:", dim(bBQ), "\n") 
    print(bB2)
    cat("Dimensions of QQ:", dim(QQ), "\n")  
    PlotQRBands_env$PlotQRbands(BQ, bBQ, B2, bB2, QQ,ylims)
  }
}
