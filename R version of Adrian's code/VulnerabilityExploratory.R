# Plot raw data, create scatterplots for univariate quantile regressions
# This script produces charts for the descriptive analysis presented in the
# following figures:
  # - Figure 2. Raw Data.
# - Figure 3. Quantile Regressions.
# The charts are saved in the folder 'FigExploratory'.
# 
# From the replication files for:
  # Tobias Adrian, Nina Boyarchenko, and Domenico Giannone (2018):
  # "Vulnerable Growth," American Economic Review.

#-------------------------------------------------------------------------------------------------------------------------------------------


# Install and load necessary packages
#install.packages(c("quantreg", "ggplot2", "readxl", "openxlsx"))
library(quantreg)
library(ggplot2)
library(readxl)

# Load the data 
data <- read_excel("DataVulnerabilityAppendix.xls")
colnames(data)[1] <- "Time"
data$Time <- as.Date(data$Time)

# Filter data
data <- data[data$Time >= as.Date("1973-01-01") & data$Time <= as.Date("2015-10-01"), ]


# Forecast settings
H <- c(1, 4)    # Horizons to forecast (# of quarters ahead)
QQ <- seq(0.05, 0.95, by=0.05)     # Quantiles to estimate in quantile regressions
jq05 <- which.min(abs(QQ - 0.05))
jq50 <- which.min(abs(QQ - 0.50))
jq95 <- which.min(abs(QQ - 0.95))

# Construct average growth rates
y <- data$A191RL1Q225SBEA
Yh <- list()
for (h in H) {
  Yh[[as.character(h)]] <- stats::filter(y, rep(1/h, h), sides=1) #it stores the growth for the next quarter and the growth for the next 4 quarters
  # ,which is an average 
}

# Plot Raw Data (GDP and NFCI)
ggplot(data) + 
  geom_line(aes(x = Time, y = A191RL1Q225SBEA), color = "blue") +
  geom_line(aes(x = Time, y = NFCI), color = "red", linetype = "dashed") +
  labs(y = "Value", x = "Time", title = "Raw Data") +
  theme_minimal()

#------- PLOT IS CORRECT, SAME ONE AS SHOWN IN THE PAPER


# Quantile Regressions
ylimsScatter <- matrix(c(-15, 20, NA, NA, NA, NA, -15, 10), ncol=2)



for (h in H) {
  # GDP on GDP
  X <- data$A191RL1Q225SBEA[seq_len(length(data$A191RL1Q225SBEA) - h)]
  y <- Yh[[as.character(h)]][(h+1):length(Yh[[as.character(h)]])]
  
  # OLS regression
  model_ols <- lm(y ~ X)
  preds_ols <- predict(model_ols, newdata = data.frame(X))
  
  # Quantile regressions
  preds_q <- matrix(NA, length(X), length(QQ))
  for (i in 1:length(QQ)) {
    model_q <- rq(y ~ X, tau = QQ[i])
    preds_q[,i] <- predict(model_q, newdata = data.frame(X))
  }
  
  # Plot for GDP on GDP
  plot1 <- ggplot(data.frame(X, y, preds_ols, preds_q), aes(x = X, y = y)) +
    geom_point() +
    geom_line(aes(y = preds_ols, color = "OLS")) +
    geom_line(aes(y = preds_q[,jq05], color = "Q5"), linetype = "dashed") +
    geom_line(aes(y = preds_q[,jq50], color = "Q50"), linetype = "dashed") +
    geom_line(aes(y = preds_q[,jq95], color = "Q95"), linetype = "dashed") +
    labs(y = paste("GDP growth", h, "quarter ahead"), x = "Current quarter GDP growth", color = "") +
    theme_minimal() +
    ylim(ylimsScatter[h,])
  print(plot1)
  
  
  # GDP on NFCI
  X <- data$NFCI[seq_len(length(data$NFCI) - h)]
  
  # OLS regression
  model_ols_nfci <- lm(y ~ X)
  preds_ols_nfci <- predict(model_ols_nfci, newdata = data.frame(X))
  
  # Quantile regressions
  preds_q_nfci <- matrix(NA, length(X), length(QQ))
  for (i in 1:length(QQ)) {
    model_q_nfci <- rq(y ~ X, tau = QQ[i])
    preds_q_nfci[,i] <- predict(model_q_nfci, newdata = data.frame(X))
  }
  
  # Plot for GDP on NFCI
  plot2 <- ggplot(data.frame(X, y, preds_ols_nfci, preds_q_nfci), aes(x = X, y = y)) +
    geom_point() +
    geom_line(aes(y = preds_ols_nfci, color = "OLS")) +
    geom_line(aes(y = preds_q_nfci[,jq05], color = "Q5"), linetype = "dashed") +
    geom_line(aes(y = preds_q_nfci[,jq50], color = "Q50"), linetype = "dashed") +
    geom_line(aes(y = preds_q_nfci[,jq95], color = "Q95"), linetype = "dashed") +
    labs(y = paste("GDP growth", h, "quarter ahead"), x = "NFCI", color = "") +
    theme_minimal() +
    ylim(ylimsScatter[h,])
  print(plot2)
}

#------------------- ALSO THESE PLOTS ARE THE SAME AS IN THE PAPER